<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Blend ERA5 and AmeriFlux Data — blend_ERA5_Flux • ERA5Flux</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Blend ERA5 and AmeriFlux Data — blend_ERA5_Flux"><meta name="description" content="This function is used to blend data from AmeriFlux and data from ERA5, ensuring they both have the same start and end timestamps. Please first make sure to run the merge function (merge_ERA5_Flux()) first, because output of merge function will be used as input of this blending function."><meta property="og:description" content="This function is used to blend data from AmeriFlux and data from ERA5, ensuring they both have the same start and end timestamps. Please first make sure to run the merge function (merge_ERA5_Flux()) first, because output of merge function will be used as input of this blending function."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ERA5Flux</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/ERA5Flux.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Malone-Disturbance-Ecology-Lab/ERA5Flux/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Blend ERA5 and AmeriFlux Data</h1>
      <small class="dont-index">Source: <a href="https://github.com/Malone-Disturbance-Ecology-Lab/ERA5Flux/blob/main/R/03B_blend_ERA5_Flux.R" class="external-link"><code>R/03B_blend_ERA5_Flux.R</code></a></small>
      <div class="d-none name"><code>blend_ERA5_Flux.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function is used to blend data from AmeriFlux and data from ERA5, ensuring they both have the same start and end timestamps. Please first make sure to run the merge function (<code><a href="merge_ERA5_Flux.html">merge_ERA5_Flux()</a></code>) first, because output of merge function will be used as input of this blending function.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">blend_ERA5_Flux</span><span class="op">(</span></span>
<span>  merged_data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  varname_FLUX <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  varname_ERA5 <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  blending_rule <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-merged-data">merged_data<a class="anchor" aria-label="anchor" href="#arg-merged-data"></a></dt>
<dd><p>(data.frame) A data frame that has a datetime stamp column named "time" with the format: "%Y-%m-%d %H:%M:%S". The time step of the "time" column is the same with that of AmeriFlux file. It also includes the columns of AmeriFlux and ERA5 data that were merged together.</p></dd>


<dt id="arg-varname-flux">varname_FLUX<a class="anchor" aria-label="anchor" href="#arg-varname-flux"></a></dt>
<dd><p>(character) A vector of variable names in AmeriFlux BASE data to be blended with ERA5 data.</p></dd>


<dt id="arg-varname-era-">varname_ERA5<a class="anchor" aria-label="anchor" href="#arg-varname-era-"></a></dt>
<dd><p>(character) A vector of variable names in ERA5 data to be blended with AmeriFlux BASE data.</p></dd>


<dt id="arg-blending-rule">blending_rule<a class="anchor" aria-label="anchor" href="#arg-blending-rule"></a></dt>
<dd><p>(character) There are four types of blending rules that can be used to blend AmeriFlux and ERA5 variables:</p><ul><li><p>"lm": Linear regression with slope. Fits a linear model with slope, FLUX ~ ERA5, then only fills missing values in FLUX with predicted values from ERA5.</p></li>
<li><p>"lm_no_intercept": Linear regression without slope. Fits a linear model without slope, FLUX ~ ERA5, then only fills missing values in FLUX with predicted values from ERA5.</p></li>
<li><p>"replace": Replace Ameriflux variable with ERA5 variable.</p></li>
<li><p>"automatic": Checks for non-missing FLUX values. If ≥50% present then uses "lm" approach. If &lt;50% present then fallback to "replace".</p></li>
</ul></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>(data.frame) A data frame with the following characteristics:</p><ul><li><p>Time step of the "time" column is the same with that of AmeriFlux file.</p></li>
<li><p>It also includes the columns of <code>varname_FLUX</code>, the columns of <code>varname_ERA5</code>.</p></li>
<li><p>Variable column with the blending rule applied on it. Name of the blended column is similar to AmeriFlux column name but with addition of "_f".</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>Please note that the length of <code>varname_FLUX</code> must be the same as the length of <code>varname_ERA5</code>; at the same location, <code>varname_FLUX</code> and <code>varname_ERA5</code> should refer to the same variable despite the fact that AmeriFlux and ERA5 may use different names for the same variable. For example, for incoming shortwave radiation, ERA5 uses "ssrd", but AmeriFlux uses "SW_IN".</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Ammara Talib and Junna Wang</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Point to a folder containing ERA5 .nc files</span></span></span>
<span class="r-in"><span><span class="va">site_folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"path_to_ERA5_download_folder"</span>, package <span class="op">=</span> <span class="st">"ERA5Flux"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Specify a site name</span></span></span>
<span class="r-in"><span><span class="va">site_name</span> <span class="op">&lt;-</span> <span class="st">"US_GL2"</span></span></span>
<span class="r-in"><span><span class="co"># Create a temporary directory to export our output to</span></span></span>
<span class="r-in"><span><span class="va">output_filepath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Convert NetCDF data to a CSV file</span></span></span>
<span class="r-in"><span><span class="fu"><a href="netcdf_to_csv.html">netcdf_to_csv</a></span><span class="op">(</span><span class="va">site_folder</span>, <span class="va">output_filepath</span>, <span class="va">site_name</span>, full_year <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Saved: US_GL2_2024_2025_ssrd.csv </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Point to AmeriFlux data</span></span></span>
<span class="r-in"><span><span class="va">filename_FLUX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"AMF_US-GL2_BASE-BADM_1-5.zip"</span>, package <span class="op">=</span> <span class="st">"ERA5Flux"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Point to ERA5 data</span></span></span>
<span class="r-in"><span><span class="va">filename_ERA5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">output_filepath</span>, pattern <span class="op">=</span> <span class="st">"US_GL2"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># List AmeriFlux variable(s) to be merged with ERA5</span></span></span>
<span class="r-in"><span><span class="va">varname_FLUX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SW_IN"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># List ERA5 variable(s) to be merged with AmeriFlux</span></span></span>
<span class="r-in"><span><span class="va">varname_ERA5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ssrd"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run the merge function first, because its output will be used as input for this blending function</span></span></span>
<span class="r-in"><span><span class="co"># Merge AmeriFlux and ERA5 data together</span></span></span>
<span class="r-in"><span><span class="va">merged_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="merge_ERA5_Flux.html">merge_ERA5_Flux</a></span><span class="op">(</span><span class="va">filename_FLUX</span>, <span class="va">filename_ERA5</span>, <span class="va">varname_FLUX</span>, <span class="va">varname_ERA5</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Specify the blending rule(s)</span></span></span>
<span class="r-in"><span><span class="va">blending_rule</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lm_no_intercept'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Blend AmeriFlux and ERA5 data together</span></span></span>
<span class="r-in"><span><span class="va">merg_blend</span> <span class="op">&lt;-</span> <span class="fu">blend_ERA5_Flux</span><span class="op">(</span><span class="va">merged_data</span>, <span class="va">varname_FLUX</span>, <span class="va">varname_ERA5</span>, <span class="va">blending_rule</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Processing: SW_IN using rule: lm_no_intercept</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Fitting linear model without intercept with formula: SW_IN ~ ssrd + 0</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">merg_blend</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  time     ssrd SW_IN  SW_IN_f</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 2024-12-31 19:00:00 663.4275    NA 44.95547</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 2024-12-31 19:30:00 331.7138    NA 22.47773</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 2024-12-31 20:00:00   0.0000    NA  0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 2024-12-31 20:30:00   0.0000    NA  0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 2024-12-31 21:00:00   0.0000    NA  0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 2024-12-31 21:30:00   0.0000    NA  0.00000</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Angel Chen, Sam Jurado, David E Reed, Ammara Talib, Junna Wang, Boya Zhang, Sparkle L Malone.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

