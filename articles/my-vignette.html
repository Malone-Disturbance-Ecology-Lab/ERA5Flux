<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>my-vignette • ERA5Flux</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="my-vignette">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ERA5Flux</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/my-vignette.html">my-vignette</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Malone-Disturbance-Ecology-Lab/ERA5Flux/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>my-vignette</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Malone-Disturbance-Ecology-Lab/ERA5Flux/blob/main/vignettes/my-vignette.Rmd" class="external-link"><code>vignettes/my-vignette.Rmd</code></a></small>
      <div class="d-none name"><code>my-vignette.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NOTE: run devtools::build_rmd("vignettes/my-vignette.Rmd") to render this vignette</span></span></code></pre></div>
<div class="section level2">
<h2 id="intro">Intro<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p>Explain ERA5Flux purpose, what is ERA5 and AmeriFlux, why is this
package useful, what is the main purpose etc.</p>
<p>Here is how to use the core functions in <code>ERA5Flux</code> in
your entire workflow.</p>
</div>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<div class="section level3">
<h3 id="step-0-get-ameriflux-data-and-site-metadata">Step 0: Get AmeriFlux data and site metadata<a class="anchor" aria-label="anchor" href="#step-0-get-ameriflux-data-and-site-metadata"></a>
</h3>
<p>First we will need to download AmeriFlux data. Navigate to <a href="https://ameriflux.lbl.gov/" class="external-link">AmeriFlux</a> and login to your
account. Once you’re logged in, you can download data at the <a href="https://ameriflux.lbl.gov/data/download-data/" class="external-link">Download
page</a>.</p>
<p>You will be presented with options on the types of data products you
would like to download. Select <strong>AmeriFlux BASE</strong> then
select <strong>CC-BY-4.0</strong> as the data use policy that you will
follow. At the next step, pick the sites that you would like, then write
a short description of your intended use for this data and agree to the
license.</p>
<p>Finally, you will be presented with a data download page that has
download links for the requested sites. Click on those download links to
get a zip file for each site. You will also need to click on the
“Requested_Files” download link to get the metadata text file for your
request. This will download as
“requested_files_manifest_YYYYMMDD.txt”.</p>
<p>After you’ve downloaded everything, unzip the site zip files. To
ensure that the rest of the workflow runs smoothly, we recommend that
you arrange your files like so:</p>
<pre><code>your-working-directory/
├── unzipped_data/          
│   ├── unzipped_site1_folder/  
│   │   ├── *.csv
│   │   └── *.xlsx
│   │
│   ├── unzipped_site2_folder/
│   │   ├── *.csv
│   │   └── *.xlsx
│   │
│   ├── unzipped_site3_folder/
│   │   ├── *.csv
│   │   └── *.xlsx
│   │
│   └── requested_files_manifest_YYYYMMDD.txt
│
├── site1_data.zip  
├── site2_data.zip 
├── site3_data.zip 
│
└── more stuff/               
    ├── ...   
    └── ...</code></pre>
<p>After arranging the files, you can now generate the AmeriFlux site
metadata.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Malone-Disturbance-Ecology-Lab/ERA5Flux" class="external-link">ERA5Flux</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify the ERA5 variables you want to get</span></span>
<span><span class="va">my_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"total_precipitation"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Point to the folder containing the unzipped site folders and requested files manifest</span></span>
<span><span class="va">my_folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"unzipped_data"</span>, package <span class="op">=</span> <span class="st">"ERA5Flux"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate the AmeriFlux site metadata file</span></span>
<span><span class="va">my_site_metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_site_metadata.html">get_site_metadata</a></span><span class="op">(</span>folder <span class="op">=</span> <span class="va">my_folder</span>,</span>
<span>                                      selected_variables <span class="op">=</span> <span class="va">my_variables</span><span class="op">)</span></span>
<span><span class="co">#&gt; selected variables: total_precipitation</span></span>
<span><span class="co">#&gt; Now checking: US-GL2</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Rows: </span><span style="color: #0000BB;">7248</span> <span style="font-weight: bold;">Columns: </span><span style="color: #0000BB;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Column specification</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Delimiter:</span> ","</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">dbl</span> (1): TIMESTAMP_START</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use `spec()` to retrieve the full column specification for this data.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></span>
<span></span>
<span><span class="va">my_site_metadata</span></span>
<span><span class="co">#&gt;   site_codes     lat      lon   startdate      enddate           variables</span></span>
<span><span class="co">#&gt; 1     US-GL2 46.7167 -87.4000 2.02501e+11 202505312330 total_precipitation</span></span></code></pre></div>
<p>The metadata dataframe will have 5 columns: <code>site_codes</code>,
<code>lat</code>, <code>lon</code>, <code>startdate</code>,
<code>enddate</code>, and <code>variables</code>. We will need this
metadata in order to build our ERA5 data requests.</p>
</div>
<div class="section level3">
<h3 id="step-1-download-era5-data">Step 1: Download ERA5 Data<a class="anchor" aria-label="anchor" href="#step-1-download-era5-data"></a>
</h3>
<p>After you get the AmeriFlux site metadata, you can now go ahead and
download ERA5 data.</p>
<p>But before that, there are a few steps you need to do.</p>
<p>First, make sure you create an account at the <a href="https://cds.climate.copernicus.eu/" class="external-link">Climate Data Store</a> if you
haven’t done so already. You may need to accept the data license
agreement first before you can download the data. Visit the <a href="https://cds.climate.copernicus.eu/profile" class="external-link">Copernicus Climate Data
Store User Profile page</a> to accept the appropriate license(s).</p>
<p>Then, <code><a href="../reference/download_ERA5.html">download_ERA5()</a></code> requires a land-sea mask so you
must download that first with <code><a href="../reference/get_land_sea_mask.html">get_land_sea_mask()</a></code>. This
function will download the land-sea mask from <a href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=140385202#ERA5Land:datadocumentation-parameterlistingParameterlistings" class="external-link">here</a></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download the land-sea mask if you haven't done so already</span></span>
<span><span class="fu"><a href="../reference/get_land_sea_mask.html">get_land_sea_mask</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now you are ready to download ERA5 data. Copy and paste your Climate
Data Store API token into the <code>my_token</code> argument. Provide
the AmeriFlux site metadata in <code>site_metadata</code>, and set the
file path to your land-sea mask as well. Finally, specify a folder path
to where you want to download your ERA5 data to.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Paste your token </span></span>
<span><span class="va">my_token</span> <span class="op">&lt;-</span> <span class="st">"my_ECMWF_token"</span></span>
<span></span>
<span><span class="co"># Set the path to your land-sea mask</span></span>
<span><span class="va">path_to_mask</span> <span class="op">&lt;-</span> <span class="st">"lsm_1279l4_0.1x0.1.grb_v4_unpack.nc"</span></span>
<span></span>
<span><span class="co"># Point to the folder where you want the ERA5 data to download to</span></span>
<span><span class="va">my_download_path</span> <span class="op">&lt;-</span> <span class="st">"path_to_ERA5_download_folder"</span></span>
<span></span>
<span><span class="co"># Download the ERA5 data</span></span>
<span><span class="fu"><a href="../reference/download_ERA5.html">download_ERA5</a></span><span class="op">(</span>my_token <span class="op">=</span> <span class="va">my_token</span>,</span>
<span>              site_metadata <span class="op">=</span> <span class="va">my_site_metadata</span>,</span>
<span>              mask <span class="op">=</span> <span class="va">path_to_mask</span>,</span>
<span>              download_path <span class="op">=</span> <span class="va">my_download_path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-data-processing">Step 2: Data Processing<a class="anchor" aria-label="anchor" href="#step-2-data-processing"></a>
</h3>
<p>After downloading the ERA5 .nc files, we convert them into CSV files
formatted to match AmeriFlux standards, enabling easy merging with
existing datasets. This conversion is handled by
<code><a href="../reference/netcdf_df_formatter.html">netcdf_df_formatter()</a></code>, which adjusts ERA5 timestamps from
UTC to local time (yyyyMMddHHmm) based on each site’s coordinates and
converts solar radiation (ssrd), air temperature (t2m), and total
precipitation (tp) to AmeriFlux units. The <code><a href="../reference/netcdf_to_csv.html">netcdf_to_csv()</a></code>
function then calls <code><a href="../reference/netcdf_df_formatter.html">netcdf_df_formatter()</a></code> for each site
folder, merging all relevant data by site and year so that each output
CSV contains one site’s data for one year. If full_year == TRUE, the
function will only return full years that begin with the first hour of
theyear and end with the last. For the purposes of this example, set
full_year == FALSE.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Point to a folder containing ERA5 .nc files</span></span>
<span><span class="va">site_folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"02_csv_conversion_ex"</span>, package <span class="op">=</span> <span class="st">"ERA5Flux"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify a site name</span></span>
<span><span class="va">site_name</span> <span class="op">&lt;-</span> <span class="st">"US_GL2"</span></span>
<span></span>
<span><span class="co"># Create a temporary directory to export our output to</span></span>
<span><span class="va">output_filepath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert NetCDF data to a CSV file</span></span>
<span><span class="fu"><a href="../reference/netcdf_to_csv.html">netcdf_to_csv</a></span><span class="op">(</span><span class="va">site_folder</span>, <span class="va">output_filepath</span>, <span class="va">site_name</span>, full_year <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Saved: US_GL2_2024_2025_tp.csv</span></span>
<span></span>
<span><span class="co"># Read the CSV back in</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">output_filepath</span>, pattern <span class="op">=</span> <span class="st">"US_GL2"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;           time         tp</span></span>
<span><span class="co">#&gt; 1 202412311900 0.40247058</span></span>
<span><span class="co">#&gt; 2 202412312000 0.03797992</span></span>
<span><span class="co">#&gt; 3 202412312100 0.07184656</span></span>
<span><span class="co">#&gt; 4 202412312200 0.10609820</span></span>
<span><span class="co">#&gt; 5 202412312300 0.12701539</span></span>
<span><span class="co">#&gt; 6 202501010000 0.15275138</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-merging-and-blending-ameriflux-with-era5-data">Step 3: Merging and Blending AmeriFlux with ERA5 Data<a class="anchor" aria-label="anchor" href="#step-3-merging-and-blending-ameriflux-with-era5-data"></a>
</h3>
<p>After you processed the ERA5, you can merge ERA5 and AmeriFlux
together.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show how to use this</span></span>
<span><span class="co"># merge_ERA5_FLUX()</span></span></code></pre></div>
<p>After merging, you can blend them together. Maybe helpful to explain
the difference between merging and blending ?</p>
<p>Final result will look like this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show how to use this</span></span>
<span><span class="co"># blend_ERA5_Flux()</span></span></code></pre></div>
<p>Maybe explain how researchers can use these results in their
work.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Angel Chen, Sam Jurado, David E Reed, Ammara Talib, Junna Wang, Boya Zhang, Sparkle L Malone.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
