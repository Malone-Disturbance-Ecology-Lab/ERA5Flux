---
title: "my-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
# NOTE: run devtools::build_rmd("vignettes/my-vignette.Rmd") to render this vignette
```

## Intro 

Explain ERA5Flux purpose, what is ERA5 and AmeriFlux, why is this package useful, what is the main purpose etc.

Here is how to use the core functions in `ERA5Flux` in your entire workflow.

## Workflow 

### Step 0: Get AmeriFlux data and site metadata

First we will need to download AmeriFlux data. Navigate to [AmeriFlux](https://ameriflux.lbl.gov/) and login to your account. Once you're logged in, you can download data at the [Download page](https://ameriflux.lbl.gov/data/download-data/).

You will be presented with options on the types of data products you would like to download. Select **AmeriFlux BASE** then select **CC-BY-4.0** as the data use policy that you will follow. At the next step, pick the sites that you would like, then write a short description of your intended use for this data and agree to the license. 

Finally, you will be presented with a data download page that has download links for the requested sites. Click on those download links to get a zip file for each site. You will also need to click on the "Requested_Files" download link to get the metadata text file for your request. This will download as "requested_files_manifest_YYYYMMDD.txt". 

After you've downloaded everything, unzip the site zip files. To ensure that the rest of the workflow runs smoothly, we recommend that you arrange your files like so:

```
your-working-directory/
├── unzipped_AmeriFlux_data/          
│   ├── unzipped_site1_folder/  
│   │   ├── *.csv
│   │   └── *.xlsx
│   │
│   ├── unzipped_site2_folder/
│   │   ├── *.csv
│   │   └── *.xlsx
│   │
│   ├── unzipped_site3_folder/
│   │   ├── *.csv
│   │   └── *.xlsx
│   │
│   └── requested_files_manifest_YYYYMMDD.txt
│
├── site1_data.zip  
├── site2_data.zip 
├── site3_data.zip 
│
└── more stuff/               
    ├── ...   
    └── ...
```
After arranging the files, you can now generate the AmeriFlux site metadata. In this example, the folder called `unzipped_AmeriFlux_data` contains the unzipped site folders and requested files manifest. 

```{r setup}
# Load the package
library(ERA5Flux)

# Specify the ERA5 variables you want to get
my_variables <- c("surface_solar_radiation_downwards")

# Point to the folder containing the unzipped site folders and requested files manifest
my_folder <- system.file("extdata", "unzipped_AmeriFlux_data", package = "ERA5Flux")

# Generate the AmeriFlux site metadata file
my_site_metadata <- get_site_metadata(folder = my_folder,
                                      selected_variables = my_variables)

my_site_metadata
```

The metadata dataframe will have 5 columns: `site_codes`, `lat`, `lon`, `startdate`, `enddate`, and `variables`. We will need this metadata in order to build our ERA5 data requests. 

### Step 1: Download ERA5 Data

After you get the AmeriFlux site metadata, you can now go ahead and download ERA5 data.

But before that, there are a few steps you need to do.

First, make sure you create an account at the [Copernicus Climate Data Store](https://cds.climate.copernicus.eu/) if you haven't done so already. You may need to accept the data license agreement first before you can download the data. Visit the [Climate Data Store User Profile page](https://cds.climate.copernicus.eu/profile) to accept the appropriate license(s). 

Then, `download_ERA5()` requires a land-sea mask so you must download that first with `get_land_sea_mask()`. This function will download the land-sea mask from [here](https://confluence.ecmwf.int/pages/viewpage.action?pageId=140385202#ERA5Land:datadocumentation-parameterlistingParameterlistings)

```{r, eval = F}
# Download the land-sea mask if you haven't done so already
get_land_sea_mask()
```

Now you are ready to download ERA5 data. Copy and paste your Climate Data Store API token into the `my_token` argument. Provide the AmeriFlux site metadata in `site_metadata`, and set the file path to your land-sea mask as well. Finally, specify a folder path to where you want to download your ERA5 data to.  

```{r, eval = F}
# Paste your token 
my_token <- "my_ECMWF_token"

# Set the path to your land-sea mask
path_to_mask <- "lsm_1279l4_0.1x0.1.grb_v4_unpack.nc"

# Point to the folder where you want the ERA5 data to download to
my_download_path <- "path_to_ERA5_download_folder"

# Download the ERA5 data
download_ERA5(my_token = my_token,
              site_metadata = my_site_metadata,
              mask = path_to_mask,
              download_path = my_download_path)
```

### Step 2: Data Processing

After downloading the ERA5 .nc files, we convert them into CSV files formatted 
to match AmeriFlux standards, enabling easy merging with existing datasets. This 
conversion is handled by `netcdf_df_formatter()`, which adjusts ERA5 timestamps 
from UTC to local time (yyyyMMddHHmm) based on each site’s coordinates and 
converts solar radiation (ssrd), air temperature (t2m), and total precipitation 
(tp) to AmeriFlux units. The `netcdf_to_csv()` function then calls 
`netcdf_df_formatter()` for each site folder, merging all relevant data by site 
and year so that each output CSV contains one site’s data for one year. If 
`full_year = TRUE`, the function will only return full years that begin with the
first hour of theyear and end with the last. For the purposes of this example,
set `full_year = FALSE`.

```{r}
# Point to a folder containing ERA5 .nc files
site_folder <- system.file("extdata", "path_to_ERA5_download_folder", package = "ERA5Flux")

# Specify a site name
site_name <- "US_GL2"

# Create a temporary directory to export our output to
output_filepath <- tempdir()

# Convert NetCDF data to a CSV file
netcdf_to_csv(site_folder, output_filepath, site_name, full_year = FALSE)

# Read the CSV back in
data <- read.csv(list.files(output_filepath, pattern = "US_GL2", full.names = TRUE))

head(data)
```




### Step 3: Merging and Blending AmeriFlux with ERA5 Data

After you processed the ERA5 data, you can merge it with the AmeriFlux data.

The `merge_ERA5_FLUX()` function synchronizes AmeriFlux tower observations with ERA5 reanalysis data, ensuring both datasets share consistent timestamps and comparable variable names. It first reads AmeriFlux BASE data, replaces missing values with `NA`, and imports the processed ERA5 CSV file generated from `netcdf_to_csv()`. Because ERA5 data are typically hourly and AmeriFlux data are often half-hourly, the function linearly interpolates ERA5 variables to match the AmeriFlux time step. It then merges the datasets based on the aligned time column, adding corresponding AmeriFlux and ERA5 variables side by side. The resulting dataframe provides a harmonized, site-specific time series that researchers can use to compare reanalysis and in situ flux measurements, fill short data gaps, and prepare blended climate–flux inputs for ecosystem or hydrological modeling.

```{r}
# Point to AmeriFlux data
ameriflux_file <- system.file("extdata", "AMF_US-GL2_BASE-BADM_1-5.zip", package = "ERA5Flux")
# Point to ERA5 data
era5_file <- list.files(output_filepath, pattern = "US_GL2", full.names = TRUE)

# List AmeriFlux variable(s) to be merged 
ameriflux_var <- c("SW_IN")
# List ERA5 variable(s) to be merged 
era5_var <- c("ssrd")

# Merge them together
merged_data <- merge_ERA5_FLUX(filename_FLUX = ameriflux_file,
                               filename_ERA5 = era5_file,
                               varname_FLUX = ameriflux_var,
                               varname_ERA5 = era5_var)

merged_data[1:20,]
```

Finally, you can blend the merged data.

The `blend_ERA5_Flux()` function combines AmeriFlux and ERA5 datasets into a single, gap-filled time series by applying flexible blending rules that determine how missing or incomplete AmeriFlux data should be replaced or adjusted using ERA5 values. Building on the merged output from `merge_ERA5_FLUX()`, this function allows users to select among four blending approaches: simple replacement, linear regression with or without an intercept, or an automatic rule that adapts based on data completeness. For example, when more than half of the AmeriFlux values are available, the function uses a regression-based correction to preserve site-specific patterns while filling gaps; otherwise, it substitutes ERA5 data directly. The blended output adds new columns (e.g., `SW_IN_f`, `TA_f`) that contain the harmonized variables, producing a continuous, high-quality dataset suitable for modeling, data assimilation, or long-term flux-climate analysis.

The final result will look something like this: 

```{r}
# Specify the blending rule(s)
blending_rule <- "replace"

# Blend them together
blended_data <- blend_ERA5_Flux(merged_data = merged_data,
                                varname_FLUX = ameriflux_var,
                                varname_ERA5 = era5_var,
                                blending_rule = blending_rule)

blended_data[1:20,]
```

In this example, the simple replacement blending rule was used, so a new `SW_IN_f` column was created with values from the ERA5 column, `ssrd`.  
